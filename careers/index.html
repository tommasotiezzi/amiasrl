<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lavora con noi â€” Amia</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* â”€â”€ Reset & Base (from Amia) â”€â”€ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6; color: #141414; background: white; overflow-x: hidden;
    }
    a { color: inherit; text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* â”€â”€ Header (Amia style) â”€â”€ */
    header {
      background: rgba(255,255,255,0.85); backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-bottom: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    }
    .header-content {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; max-width: 1200px; margin: 0 auto; padding-left: 20px; padding-right: 20px;
    }
    .logo { display: flex; align-items: center; gap: 8px; }
    .logo img { height: 32px; width: auto; }
    .header-nav { display: flex; align-items: center; gap: 32px; }
    .header-nav a { font-size: 14px; font-weight: 500; color: #141414; transition: opacity 0.2s; }
    .header-nav a:hover { opacity: 0.6; }
    .header-btn {
      background: #141414; color: white !important; padding: 10px 20px; border-radius: 25px;
      font-weight: 500; font-size: 14px; transition: background 0.3s;
    }
    .header-btn:hover { background: #333; }

    /* â”€â”€ Footer (Amia style) â”€â”€ */
    .main-footer { background: #141414; color: white; padding: 60px 0; }
    .footer-inner {
      display: grid; grid-template-columns: 3fr 2fr 1.5fr; gap: 80px;
      max-width: 1200px; margin: 0 auto; padding: 0 20px;
    }
    .footer-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .footer-logo img { height: 32px; filter: invert(1) brightness(2); }
    .footer-logo span { font-size: 32px; font-weight: 300; }
    .footer-tagline { font-size: 18px; font-weight: 300; line-height: 1.3; }
    .footer-title { font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 16px; }
    .footer-contact p { font-size: 16px; font-weight: 300; line-height: 1.6; }
    .footer-contact a { color: white; }

    /* â”€â”€ Page container â”€â”€ */
    #app { min-height: calc(100vh - 200px); padding-top: 80px; }

    /* â”€â”€ Spinner â”€â”€ */
    .spinner {
      width: 24px; height: 24px; border: 2px solid #e5e5e5;
      border-top-color: #141414; border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-center { display: flex; justify-content: center; padding: 120px 0; }

    /* â”€â”€ Jobs list page â”€â”€ */
    .jobs-hero {
      text-align: center; padding: 80px 0 60px;
      background-image:
        radial-gradient(ellipse 70% 50% at center, transparent 30%, white 70%),
        radial-gradient(circle, #e0e0e0 1px, transparent 1px);
      background-size: 100% 100%, 20px 20px;
    }
    .jobs-hero h1 { font-size: 52px; font-weight: 300; margin-bottom: 16px; }
    .jobs-hero p { font-size: 18px; font-weight: 300; color: #666; max-width: 600px; margin: 0 auto; }

    .jobs-section { padding: 0 0 80px; }
    .jobs-grid { display: flex; flex-direction: column; gap: 16px; max-width: 800px; margin: 0 auto; }

    .job-card {
      display: flex; align-items: center; justify-content: space-between;
      padding: 28px 32px; background: white; border: 1px solid #eee; border-radius: 16px;
      transition: all 0.3s ease; cursor: pointer;
    }
    .job-card:hover {
      border-color: #ccc; box-shadow: 0 8px 32px rgba(0,0,0,0.08); transform: translateY(-2px);
    }
    .job-card-info h3 { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
    .job-card-meta { display: flex; gap: 16px; }
    .job-card-meta span {
      font-size: 13px; color: #999; font-weight: 400;
      display: flex; align-items: center; gap: 4px;
    }
    .job-card-arrow {
      width: 40px; height: 40px; background: #f5f5f5; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; transition: all 0.3s;
      flex-shrink: 0;
    }
    .job-card:hover .job-card-arrow { background: #141414; color: white; }
    .job-card-arrow svg { width: 16px; height: 16px; }

    .no-jobs {
      text-align: center; padding: 80px 0;
      font-size: 16px; color: #999; font-weight: 300;
    }

    /* â”€â”€ Job detail / apply page â”€â”€ */
    .job-detail { max-width: 800px; margin: 0 auto; padding: 60px 20px 80px; }
    .job-back {
      font-size: 13px; color: #999; display: inline-flex; align-items: center; gap: 4px;
      margin-bottom: 32px; transition: color 0.2s;
    }
    .job-back:hover { color: #141414; }
    .job-detail h1 { font-size: 42px; font-weight: 300; margin-bottom: 12px; }
    .job-detail-meta { display: flex; gap: 16px; margin-bottom: 40px; }
    .job-detail-meta span {
      font-size: 14px; color: #999; font-weight: 400;
      display: flex; align-items: center; gap: 4px;
    }
    .job-description {
      font-size: 16px; line-height: 1.8; color: #444; font-weight: 300;
      margin-bottom: 48px; white-space: pre-line;
    }

    /* â”€â”€ Application form â”€â”€ */
    .apply-section { border-top: 1px solid #eee; padding-top: 48px; }
    .apply-section h2 { font-size: 28px; font-weight: 600; margin-bottom: 8px; }
    .apply-section .subtitle { font-size: 15px; color: #999; font-weight: 300; margin-bottom: 32px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full { grid-column: 1 / -1; }
    .form-label { font-size: 13px; font-weight: 500; color: #141414; margin-bottom: 6px; }
    .form-input, .form-textarea {
      width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 12px;
      font-size: 15px; font-family: inherit; color: #141414; background: white;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-textarea:focus {
      outline: none; border-color: #141414;
    }
    .form-input::placeholder, .form-textarea::placeholder { color: #bbb; }
    .form-textarea { resize: none; min-height: 120px; }

    .form-file-label {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 14px 16px; border: 2px dashed #e0e0e0; border-radius: 12px;
      font-size: 14px; color: #999; cursor: pointer; transition: all 0.2s;
    }
    .form-file-label:hover { border-color: #999; color: #666; }
    .form-file-label.has-file { border-color: #141414; color: #141414; border-style: solid; }
    .form-file-input { display: none; }

    .submit-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: #141414; color: white; padding: 16px 32px; border-radius: 50px;
      font-size: 16px; font-weight: 600; font-family: inherit; border: none;
      cursor: pointer; transition: all 0.3s; margin-top: 24px;
    }
    .submit-btn:hover { background: #333; transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .submit-btn svg { width: 16px; height: 16px; }

    /* â”€â”€ Auth section â”€â”€ */
    .auth-box {
      background: #f8f8f8; border-radius: 16px; padding: 32px; margin-bottom: 32px;
    }
    .auth-box h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .auth-box .subtitle { margin-bottom: 20px; }
    .auth-toggle {
      font-size: 13px; color: #999; margin-top: 12px;
    }
    .auth-toggle a { color: #141414; font-weight: 500; cursor: pointer; }
    .auth-toggle a:hover { text-decoration: underline; }

    /* â”€â”€ Portal (candidate dashboard) â”€â”€ */
    .portal-hero { padding: 60px 0 40px; text-align: center; }
    .portal-hero h1 { font-size: 36px; font-weight: 300; margin-bottom: 8px; }
    .portal-hero p { font-size: 16px; color: #999; font-weight: 300; }
    .portal-section { max-width: 800px; margin: 0 auto; padding: 0 20px 80px; }

    .app-card {
      background: white; border: 1px solid #eee; border-radius: 16px;
      padding: 24px 28px; margin-bottom: 12px; transition: all 0.3s;
    }
    .app-card:hover { border-color: #ccc; box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
    .app-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .app-card-header h3 { font-size: 18px; font-weight: 600; }
    .status-badge {
      font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px;
    }
    .status-applied { background: #e8f0fe; color: #1a73e8; }
    .status-interview { background: #fef3e0; color: #e65100; }
    .status-hired { background: #e6f4ea; color: #1b7a3d; }
    .status-rejected { background: #fce8e6; color: #c62828; }

    .quiz-progress { display: flex; gap: 8px; flex-wrap: wrap; }
    .quiz-chip {
      font-size: 12px; font-weight: 500; padding: 6px 12px; border-radius: 8px;
      display: flex; align-items: center; gap: 4px;
    }
    .quiz-done { background: #e6f4ea; color: #1b7a3d; }
    .quiz-pending { background: #f5f5f5; color: #999; }
    .quiz-btn {
      background: #141414; color: white; border: none; cursor: pointer;
      font-family: inherit; border-radius: 8px; padding: 6px 14px;
      font-size: 12px; font-weight: 600; transition: background 0.2s;
    }
    .quiz-btn:hover { background: #333; }

    /* â”€â”€ Quiz taking â”€â”€ */
    .quiz-page { max-width: 700px; margin: 0 auto; padding: 60px 20px 80px; }
    .quiz-page h1 { font-size: 32px; font-weight: 300; margin-bottom: 8px; }
    .quiz-timer {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 14px; font-weight: 600; color: #141414;
      background: #f5f5f5; padding: 8px 16px; border-radius: 20px;
      margin-bottom: 32px;
    }
    .quiz-timer.warning { background: #fce8e6; color: #c62828; }

    .question-card {
      background: white; border: 1px solid #eee; border-radius: 16px;
      padding: 24px 28px; margin-bottom: 16px;
    }
    .question-num { font-size: 12px; font-weight: 600; color: #999; margin-bottom: 8px; }
    .question-text { font-size: 16px; font-weight: 400; margin-bottom: 16px; line-height: 1.5; }

    .mc-option {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border: 1px solid #eee; border-radius: 10px; cursor: pointer;
      transition: all 0.2s; margin-bottom: 8px;
    }
    .mc-option:hover { border-color: #ccc; background: #fafafa; }
    .mc-option.selected { border-color: #141414; background: #f8f8f8; }
    .mc-radio {
      width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      transition: all 0.2s;
    }
    .mc-option.selected .mc-radio { border-color: #141414; }
    .mc-option.selected .mc-radio::after {
      content: ''; width: 10px; height: 10px; background: #141414; border-radius: 50%;
    }
    .mc-checkbox {
      width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 6px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      transition: all 0.2s;
    }
    .mc-option.selected .mc-checkbox { border-color: #141414; background: #141414; }
    .mc-option.selected .mc-checkbox::after {
      content: 'âœ“'; color: white; font-size: 12px; font-weight: 700;
    }
    .mc-label { font-size: 15px; color: #141414; }

    .open-textarea {
      width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 12px;
      font-size: 15px; font-family: inherit; color: #141414; resize: none; min-height: 100px;
    }
    .open-textarea:focus { outline: none; border-color: #141414; }

    /* â”€â”€ Toast â”€â”€ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #141414; color: white; padding: 14px 24px; border-radius: 12px;
      font-size: 14px; font-weight: 500; z-index: 9999;
      opacity: 0; transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }
    .toast.error { background: #c62828; }

    /* â”€â”€ Logged-in bar â”€â”€ */
    .user-bar {
      font-size: 13px; color: #999; display: flex; align-items: center; gap: 12px;
    }
    .user-bar button {
      background: none; border: none; color: #999; font-size: 13px; font-family: inherit;
      cursor: pointer; text-decoration: underline;
    }
    .user-bar button:hover { color: #141414; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 768px) {
      .jobs-hero h1 { font-size: 32px; }
      .jobs-hero p { font-size: 16px; }
      .job-card { padding: 20px 24px; }
      .job-card-info h3 { font-size: 17px; }
      .job-detail h1 { font-size: 28px; }
      .form-grid { grid-template-columns: 1fr; }
      .header-nav { gap: 20px; }
      .header-nav .nav-link { display: none; }
      .footer-inner { grid-template-columns: 1fr; gap: 40px; text-align: center; }
      .portal-hero h1 { font-size: 28px; }
      .quiz-page h1 { font-size: 24px; }
    }
  </style>
</head>
<body>

  <!-- â”€â”€ Header â”€â”€ -->
  <header>
    <div class="header-content">
      <a href="https://amia.technology" class="logo">
        <img src="../Images/Loghi/AMIA-LOGO-black-O.svg" alt="Amia">
      </a>
      <nav class="header-nav">
        <a href="#/" class="nav-link">Posizioni aperte</a>
        <a href="#/portal" class="nav-link">La mia area</a>
        <a href="https://amia.technology" class="header-btn">Torna al sito</a>
      </nav>
    </div>
  </header>

  <!-- â”€â”€ App â”€â”€ -->
  <div id="app">
    <div class="loading-center"><div class="spinner"></div></div>
  </div>

  <!-- â”€â”€ Footer â”€â”€ -->
  <footer class="main-footer">
    <div class="footer-inner">
      <div>
        <div class="footer-logo">
          <img src="../Images/Loghi/AMIA-LOGO-black-O.svg" alt="Amia">
          <span>Amia</span>
        </div>
        <div class="footer-tagline">Innovate Today,<br>Shape Tomorrow</div>
      </div>
      <div>
        <div class="footer-title">CONTATTI</div>
        <div class="footer-contact">
          <p><a href="mailto:info@amiasrl.it">info@amiasrl.it</a></p>
          <p>Portico Antica Fonte 11<br>Darfo Boario Terme (BS) 25047</p>
          <p>P.IVA 04501060984</p>
        </div>
      </div>
      <div>
        <div class="footer-title">SEGUICI</div>
      </div>
    </div>
  </footer>

  <!-- â”€â”€ Toast â”€â”€ -->
  <div id="toast" class="toast"></div>

  <script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AMIA CAREERS â€” Portale Candidato
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const { createClient } = supabase;
  const sb = createClient(
    'https://lekkiacgjhjdhfzztpwd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxla2tpYWNnamhqZGhmenp0cHdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjA3OTMsImV4cCI6MjA4NjAzNjc5M30.69UEjEoyV-v6ZYR4QgsyVusQhtWesCEA_EEizHSEyHg'
  );

  const app = document.getElementById('app');
  let currentUser = null;
  let currentCandidate = null;

  // â”€â”€ Toast â”€â”€
  function toast(msg, isError) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => t.className = 'toast', 3000);
  }

  // â”€â”€ Router â”€â”€
  async function route() {
    const hash = location.hash.slice(1) || '/';
    const parts = hash.split('/').filter(Boolean);

    // Check auth
    const { data: { user } } = await sb.auth.getUser();
    currentUser = user;

    if (user && !currentCandidate) {
      const { data } = await sb.from('candidates').select('*').eq('user_id', user.id).single();
      currentCandidate = data;
    }

    if (parts[0] === 'apply' && parts[1]) {
      await renderApply(parts[1]);
    } else if (parts[0] === 'portal') {
      if (!currentUser) { location.hash = '#/'; return; }
      await renderPortal();
    } else if (parts[0] === 'quiz' && parts[1]) {
      if (!currentUser) { location.hash = '#/'; return; }
      await renderQuiz(parts[1], parts[2]);
    } else {
      await renderJobsList();
    }
  }

  window.addEventListener('hashchange', route);

  // â”€â”€ Init â”€â”€
  sb.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user || null;
    if (!currentUser) currentCandidate = null;
  });
  route();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAGE: Jobs List
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderJobsList() {
    app.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

    const { data: positions } = await sb
      .from('positions').select('id, title, department, location, contract_type, slug')
      .eq('status', 'published').order('published_at', { ascending: false });

    const jobs = positions || [];

    app.innerHTML = `
      <section class="jobs-hero">
        <div class="container">
          <h1>Lavora con noi</h1>
          <p>Unisciti al team che sta costruendo il futuro di Amia. Cerchiamo persone curiose, appassionate e con voglia di fare.</p>
        </div>
      </section>
      <section class="jobs-section">
        <div class="container">
          ${jobs.length > 0 ? `
            <div class="jobs-grid">
              ${jobs.map(j => `
                <a href="#/apply/${j.slug || j.id}" class="job-card">
                  <div class="job-card-info">
                    <h3>${j.title}</h3>
                    <div class="job-card-meta">
                      <span>${j.department}</span>
                      <span>Â·</span>
                      <span>${j.location}</span>
                      <span>Â·</span>
                      <span>${contractLabel(j.contract_type)}</span>
                    </div>
                  </div>
                  <div class="job-card-arrow">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                </a>
              `).join('')}
            </div>
          ` : `
            <p class="no-jobs">Al momento non ci sono posizioni aperte, ma torna a trovarci!</p>
          `}
        </div>
      </section>
    `;
  }

  function contractLabel(t) {
    const map = { 'full-time': 'Full-time', 'part-time': 'Part-time', 'freelance': 'Freelance', 'internship': 'Stage' };
    return map[t] || t;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAGE: Apply
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderApply(slug) {
    app.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

    // Try by slug first, then by id
    let { data: position } = await sb
      .from('positions').select('*')
      .eq('slug', slug).eq('status', 'published').single();

    if (!position) {
      const res = await sb.from('positions').select('*')
        .eq('id', slug).eq('status', 'published').single();
      position = res.data;
    }

    if (!position) {
      app.innerHTML = '<div class="job-detail"><p class="no-jobs">Posizione non trovata.</p></div>';
      return;
    }

    const isLoggedIn = !!currentUser;

    app.innerHTML = `
      <div class="job-detail">
        <a href="#/" class="job-back">â† Tutte le posizioni</a>
        <h1>${position.title}</h1>
        <div class="job-detail-meta">
          <span>${position.department}</span>
          <span>Â·</span>
          <span>${position.location}</span>
          <span>Â·</span>
          <span>${contractLabel(position.contract_type)}</span>
        </div>
        <div class="job-description">${position.description || ''}</div>

        <div class="apply-section">
          <h2>Candidati</h2>
          <p class="subtitle">Compila il form per candidarti a questa posizione.</p>

          ${isLoggedIn ? `
            <div class="auth-box">
              <p style="font-size:14px; color:#666">
                Stai candidandoti come <strong>${currentUser.email}</strong>
                <span style="margin-left:8px; font-size:12px; color:#999; cursor:pointer" onclick="logout()">Esci</span>
              </p>
            </div>
          ` : `
            <div class="auth-box" id="auth-box">
              <div id="auth-form">
                <h3 id="auth-title">Crea il tuo account</h3>
                <p class="subtitle" id="auth-subtitle">Serve un account per candidarti e completare i quiz.</p>
                <div class="form-grid">
                  <div class="form-group" id="auth-email-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="auth-email" class="form-input" placeholder="la.tua@email.com">
                  </div>
                  <div class="form-group" id="auth-pass-group">
                    <label class="form-label">Password *</label>
                    <input type="password" id="auth-pass" class="form-input" placeholder="Minimo 6 caratteri">
                  </div>
                </div>
                <button class="submit-btn" style="margin-top:16px; padding:12px 24px; font-size:14px" onclick="handleAuth()">
                  <span id="auth-btn-text">Crea account</span>
                </button>
                <p class="auth-toggle">
                  <span id="auth-toggle-text">Hai giÃ  un account?</span>
                  <a id="auth-toggle-link" onclick="toggleAuth()">Accedi</a>
                </p>
              </div>
            </div>
          `}

          <form id="apply-form" onsubmit="handleApply(event, '${position.id}')" ${!isLoggedIn ? 'style="opacity:0.5;pointer-events:none"' : ''}>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Nome *</label>
                <input type="text" id="f-first" class="form-input" placeholder="Mario" required
                  value="${currentCandidate?.first_name || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Cognome *</label>
                <input type="text" id="f-last" class="form-input" placeholder="Rossi" required
                  value="${currentCandidate?.last_name || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Telefono</label>
                <input type="tel" id="f-phone" class="form-input" placeholder="+39 333 1234567"
                  value="${currentCandidate?.phone || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">LinkedIn</label>
                <input type="url" id="f-linkedin" class="form-input" placeholder="https://linkedin.com/in/..."
                  value="${currentCandidate?.linkedin_url || ''}">
              </div>
              <div class="form-group full">
                <label class="form-label">Lettera di presentazione</label>
                <textarea id="f-cover" class="form-textarea" placeholder="Raccontaci perchÃ© ti piacerebbe lavorare con noi..."></textarea>
              </div>
              <div class="form-group full">
                <label class="form-label">CV (PDF)</label>
                <label class="form-file-label" id="cv-label">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <span id="cv-label-text">Carica il tuo CV</span>
                  <input type="file" id="f-cv" class="form-file-input" accept=".pdf" onchange="onFileChange(this)">
                </label>
              </div>
            </div>
            <button type="submit" class="submit-btn" id="apply-submit-btn">
              Invia candidatura
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    `;
  }

  // â”€â”€ Auth â”€â”€
  let isLogin = false;

  function toggleAuth() {
    isLogin = !isLogin;
    document.getElementById('auth-title').textContent = isLogin ? 'Accedi' : 'Crea il tuo account';
    document.getElementById('auth-subtitle').textContent = isLogin
      ? 'Usa le credenziali del tuo account.'
      : 'Serve un account per candidarti e completare i quiz.';
    document.getElementById('auth-btn-text').textContent = isLogin ? 'Accedi' : 'Crea account';
    document.getElementById('auth-toggle-text').textContent = isLogin ? 'Non hai un account?' : 'Hai giÃ  un account?';
    document.getElementById('auth-toggle-link').textContent = isLogin ? 'Registrati' : 'Accedi';
  }

  async function handleAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const pass = document.getElementById('auth-pass').value;
    if (!email || !pass) { toast('Compila email e password', true); return; }

    let result;
    if (isLogin) {
      result = await sb.auth.signInWithPassword({ email, password: pass });
    } else {
      result = await sb.auth.signUp({ email, password: pass });
    }

    if (result.error) {
      toast(result.error.message, true);
      return;
    }

    currentUser = result.data.user;
    toast(isLogin ? 'Accesso effettuato!' : 'Account creato!');
    route();
  }

  async function logout() {
    await sb.auth.signOut();
    currentUser = null;
    currentCandidate = null;
    route();
  }
  window.logout = logout;

  // â”€â”€ File change â”€â”€
  function onFileChange(input) {
    const label = document.getElementById('cv-label');
    const text = document.getElementById('cv-label-text');
    if (input.files.length) {
      const file = input.files[0];
      if (file.type !== 'application/pdf') {
        toast('Solo file PDF', true); input.value = ''; return;
      }
      if (file.size > 10 * 1024 * 1024) {
        toast('Il file supera 10 MB', true); input.value = ''; return;
      }
      label.classList.add('has-file');
      const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
      text.textContent = `${file.name} (${sizeMB} MB)`;
    } else {
      label.classList.remove('has-file');
      text.textContent = 'Carica il tuo CV';
    }
  }
  window.onFileChange = onFileChange;

  // â”€â”€ Submit application â”€â”€
  async function handleApply(e, positionId) {
    e.preventDefault();
    if (!currentUser) { toast('Devi prima accedere', true); return; }

    const btn = document.getElementById('apply-submit-btn');
    btn.disabled = true;
    btn.textContent = 'Invio in corso...';

    const first = document.getElementById('f-first').value.trim();
    const last = document.getElementById('f-last').value.trim();
    if (!first || !last) { toast('Nome e cognome sono obbligatori', true); btn.disabled = false; btn.textContent = 'Invia candidatura'; return; }

    // Upsert candidate
    const candidatePayload = {
      user_id: currentUser.id,
      first_name: first,
      last_name: last,
      email: currentUser.email,
      phone: document.getElementById('f-phone').value.trim() || null,
      linkedin_url: document.getElementById('f-linkedin').value.trim() || null,
    };

    let candidateId;
    if (currentCandidate) {
      await sb.from('candidates').update(candidatePayload).eq('id', currentCandidate.id);
      candidateId = currentCandidate.id;
    } else {
      const { data, error } = await sb.from('candidates').insert(candidatePayload).select().single();
      if (error) { toast('Errore: ' + error.message, true); btn.disabled = false; return; }
      candidateId = data.id;
      currentCandidate = data;
    }

    // Check duplicate
    const { data: existing } = await sb.from('applications')
      .select('id').eq('position_id', positionId).eq('candidate_id', candidateId).single();
    if (existing) { toast('Hai giÃ  una candidatura per questa posizione', true); btn.disabled = false; return; }

    // Upload CV
    let cvPath = null;
    const cvInput = document.getElementById('f-cv');
    const cvFile = cvInput.files[0];
    if (cvFile) {
      if (cvFile.type !== 'application/pdf') {
        toast('Il CV deve essere un file PDF', true); btn.disabled = false; btn.textContent = 'Invia candidatura'; return;
      }
      if (cvFile.size > 10 * 1024 * 1024) {
        toast('Il CV non puÃ² superare 10 MB', true); btn.disabled = false; btn.textContent = 'Invia candidatura'; return;
      }
      const fileName = `${candidateId}/${Date.now()}_${cvFile.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
      const { error: uploadError } = await sb.storage.from('cvs').upload(fileName, cvFile, {
        contentType: 'application/pdf',
        upsert: false,
      });
      if (uploadError) {
        toast('Errore upload CV: ' + uploadError.message, true); btn.disabled = false; btn.textContent = 'Invia candidatura'; return;
      }
      cvPath = fileName;
    }

    // Create application
    const { error: appError } = await sb.from('applications').insert({
      position_id: positionId,
      candidate_id: candidateId,
      status: 'applied',
      cover_letter: document.getElementById('f-cover').value.trim() || null,
      cv_file_path: cvPath,
    });

    if (appError) { toast('Errore: ' + appError.message, true); btn.disabled = false; return; }

    toast('Candidatura inviata! ğŸ‰');
    setTimeout(() => { location.hash = '#/portal'; }, 1500);
  }
  window.handleApply = handleApply;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAGE: Portal (candidate dashboard)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderPortal() {
    app.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

    if (!currentCandidate) {
      app.innerHTML = `
        <div class="portal-hero"><h1>La mia area</h1><p>Non hai ancora candidature.</p></div>
        <div class="portal-section" style="text-align:center">
          <a href="#/" class="submit-btn" style="display:inline-flex;text-decoration:none">Scopri le posizioni aperte</a>
        </div>
      `;
      return;
    }

    const { data: applications } = await sb
      .from('applications')
      .select('*, position:positions(title, department, pre_quiz_id, post_quiz_id, att_quiz_id)')
      .eq('candidate_id', currentCandidate.id)
      .order('created_at', { ascending: false });

    const apps = (applications || []).map(a => ({
      ...a,
      position: Array.isArray(a.position) ? a.position[0] : a.position,
    }));

    const statusLabels = { applied: 'Candidato', interview: 'Colloquio', hired: 'Assunto', rejected: 'Scartato' };

    app.innerHTML = `
      <section class="portal-hero">
        <div class="container">
          <h1>Ciao, ${currentCandidate.first_name} ğŸ‘‹</h1>
          <p>Ecco le tue candidature e i quiz da completare.</p>
          <div class="user-bar" style="justify-content:center; margin-top:12px">
            <span>${currentUser.email}</span>
            <button onclick="logout()">Esci</button>
          </div>
        </div>
      </section>
      <section class="portal-section">
        ${apps.length > 0 ? apps.map(a => {
          const p = a.position;
          const quizzes = [];
          if (p.pre_quiz_id) quizzes.push({ type: 'pre', label: 'Quiz Logica', id: p.pre_quiz_id, done: !!a.pre_quiz_completed_at });
          if (p.post_quiz_id) quizzes.push({ type: 'post', label: 'Quiz Skills', id: p.post_quiz_id, done: !!a.post_quiz_completed_at });
          if (p.att_quiz_id) quizzes.push({ type: 'att', label: 'Attitudinale', id: p.att_quiz_id, done: !!a.att_quiz_completed_at });

          return `
            <div class="app-card">
              <div class="app-card-header">
                <h3>${p.title}</h3>
                <span class="status-badge status-${a.status}">${statusLabels[a.status] || a.status}</span>
              </div>
              <div class="quiz-progress">
                ${quizzes.map(q => q.done
                  ? `<span class="quiz-chip quiz-done">âœ“ ${q.label}</span>`
                  : `<button class="quiz-btn" onclick="location.hash='#/quiz/${a.id}/${q.type}'">${q.label} â†’</button>`
                ).join('')}
              </div>
            </div>
          `;
        }).join('') : `
          <p class="no-jobs">Nessuna candidatura. <a href="#/" style="color:#141414; font-weight:600; text-decoration:underline">Scopri le posizioni aperte</a></p>
        `}
      </section>
    `;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAGE: Quiz Taking
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderQuiz(applicationId, quizType) {
    app.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

    // Get application + position to find quiz ID
    const { data: application } = await sb
      .from('applications')
      .select('*, position:positions(*)')
      .eq('id', applicationId).single();

    if (!application) { toast('Candidatura non trovata', true); location.hash = '#/portal'; return; }

    const pos = Array.isArray(application.position) ? application.position[0] : application.position;
    const quizIdMap = { pre: pos.pre_quiz_id, post: pos.post_quiz_id, att: pos.att_quiz_id };
    const completedMap = { pre: application.pre_quiz_completed_at, post: application.post_quiz_completed_at, att: application.att_quiz_completed_at };
    const quizId = quizIdMap[quizType];

    if (!quizId) { toast('Quiz non disponibile', true); location.hash = '#/portal'; return; }
    if (completedMap[quizType]) { toast('Hai giÃ  completato questo quiz'); location.hash = '#/portal'; return; }

    // Fetch quiz + questions
    const [quizRes, questionsRes] = await Promise.all([
      sb.from('quizzes').select('*').eq('id', quizId).single(),
      sb.from('quiz_questions').select('*').eq('quiz_id', quizId).order('sort_order'),
    ]);

    const quiz = quizRes.data;
    const questions = questionsRes.data || [];

    if (!quiz) { toast('Quiz non trovato', true); location.hash = '#/portal'; return; }

    // Timer state
    const startTime = Date.now();
    const durationMs = quiz.duration_minutes ? quiz.duration_minutes * 60000 : null;
    const answers = {};

    app.innerHTML = `
      <div class="quiz-page">
        <a href="#/portal" class="job-back">â† Le mie candidature</a>
        <h1>${quiz.title}</h1>
        ${quiz.description ? `<p style="color:#666; font-size:15px; font-weight:300; margin-bottom:16px">${quiz.description}</p>` : ''}
        ${durationMs ? `<div class="quiz-timer" id="quiz-timer">â± --:--</div>` : ''}

        <div id="quiz-questions">
          ${questions.map((q, i) => questionHtml(q, i)).join('')}
        </div>

        <button class="submit-btn" id="quiz-submit" onclick="submitQuiz()">
          Consegna quiz
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
          </svg>
        </button>
      </div>
    `;

    // Timer
    if (durationMs) {
      const timerEl = document.getElementById('quiz-timer');
      const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const remaining = Math.max(0, durationMs - elapsed);
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        timerEl.textContent = `â± ${mins}:${String(secs).padStart(2, '0')}`;
        if (remaining < 300000) timerEl.classList.add('warning');
        if (remaining <= 0) { clearInterval(interval); timerEl.textContent = 'â± Tempo scaduto'; }
      }, 1000);
    }

    // MC click handlers
    document.querySelectorAll('.mc-option').forEach(opt => {
      opt.addEventListener('click', () => {
        const qId = opt.dataset.question;
        const val = parseInt(opt.dataset.value);
        const q = questions.find(x => x.id === qId);
        const config = q.config || {};
        const multi = config.allow_multiple;

        if (multi) {
          if (!answers[qId]) answers[qId] = [];
          const idx = answers[qId].indexOf(val);
          if (idx >= 0) answers[qId].splice(idx, 1);
          else answers[qId].push(val);
        } else {
          answers[qId] = [val];
        }

        // Update UI
        opt.closest('.question-card').querySelectorAll('.mc-option').forEach(o => {
          const v = parseInt(o.dataset.value);
          const selected = (answers[qId] || []).includes(v);
          o.classList.toggle('selected', selected);
        });
      });
    });

    // Open text handlers
    document.querySelectorAll('.open-textarea').forEach(ta => {
      ta.addEventListener('input', () => { answers[ta.dataset.question] = ta.value; });
    });

    // Submit
    window.submitQuiz = async function() {
      const btn = document.getElementById('quiz-submit');
      btn.disabled = true;
      btn.textContent = 'Invio in corso...';

      const elapsed = Date.now() - startTime;
      const overTime = durationMs ? elapsed > durationMs : false;

      // Build responses
      const responses = questions.map(q => {
        const ans = answers[q.id];
        const config = q.config || {};
        const isMC = q.question_type === 'multiple_choice';

        let isCorrect = null;
        let pointsEarned = 0;

        if (isMC && Array.isArray(ans)) {
          const correct = config.correct || [];
          isCorrect = JSON.stringify(ans.sort()) === JSON.stringify(correct.sort());
          pointsEarned = isCorrect ? q.points : 0;
        }

        return {
          question_id: q.id,
          answer: ans || (isMC ? [] : ''),
          is_correct: isCorrect,
          points_earned: pointsEarned,
        };
      });

      const totalScore = responses.reduce((sum, r) => sum + (r.points_earned || 0), 0);
      const maxScore = questions.reduce((sum, q) => sum + q.points, 0);

      // Build update payload based on quiz type
      const now = new Date().toISOString();
      const startedIso = new Date(startTime).toISOString();
      const update = {};

      if (quizType === 'pre') {
        update.pre_quiz_score = totalScore;
        update.pre_quiz_max_score = maxScore;
        update.pre_quiz_responses = responses;
        update.pre_quiz_started_at = startedIso;
        update.pre_quiz_completed_at = now;
        update.pre_quiz_over_time = overTime;
      } else if (quizType === 'post') {
        update.post_quiz_score = totalScore;
        update.post_quiz_max_score = maxScore;
        update.post_quiz_responses = responses;
        update.post_quiz_started_at = startedIso;
        update.post_quiz_completed_at = now;
        update.post_quiz_over_time = overTime;
      } else {
        update.att_quiz_responses = responses;
        update.att_quiz_completed_at = now;
      }

      const { error } = await sb.from('applications').update(update).eq('id', applicationId);
      if (error) { toast('Errore: ' + error.message, true); btn.disabled = false; return; }

      toast('Quiz completato! ğŸ‰');
      setTimeout(() => { location.hash = '#/portal'; }, 1500);
    };
  }

  function questionHtml(q, i) {
    const config = q.config || {};
    const options = config.options || [];
    const multi = config.allow_multiple;

    let body = '';
    if (q.question_type === 'multiple_choice') {
      body = options.map((opt, j) => `
        <div class="mc-option" data-question="${q.id}" data-value="${j}">
          <div class="${multi ? 'mc-checkbox' : 'mc-radio'}"></div>
          <span class="mc-label">${opt}</span>
        </div>
      `).join('');
    } else if (q.question_type === 'open_text') {
      body = `<textarea class="open-textarea" data-question="${q.id}" placeholder="Scrivi la tua risposta..." rows="4"></textarea>`;
    } else {
      body = `<p style="color:#999; font-size:14px">Upload file â€” disponibile a breve</p>`;
    }

    return `
      <div class="question-card">
        <div class="question-num">Domanda ${i + 1} di ${document.querySelectorAll ? '' : ''}${q.points > 0 ? ` Â· ${q.points} punti` : ''}</div>
        <div class="question-text">${q.question_text}</div>
        ${body}
      </div>
    `;
  }

  // Make functions global
  window.handleAuth = handleAuth;
  window.toggleAuth = toggleAuth;
  </script>
</body>
</html>
